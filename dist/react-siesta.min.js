var FAKE_DEFERRED={promise:null,reject:function(){},resolve:function(){}},isArray=Array.isArray||function(e){return"[object Array]"===_.toString.call(e)},SiestaMixin={componentWillMount:function(){this.listeners=[]},_cancelListeners:function(){for(var e=0;e<this.listeners.length;e++){var t=this.listeners[e];t()}this.listeners=[]},componentWillUnmount:function(){this._cancelListeners()},_listenToModel:function(e,t){var n;if(!e.singleton)throw new Error("Cannot listen to a Model if it is not a singleton");return e.one(function(e,i){console.log("singleton",i),e?t(e):(n=this.listen(i,function(e){t(e)}),this.listeners.push(n))}.bind(this)),function(){if(n){var e=this.listeners.indexOf(n);this.listeners.splice(e,1),n()}}.bind(this)},wrapCancelListen:function(e){var t;return"function"==typeof e&&(t=function(){var t=this.listeners.indexOf(e);this.listeners.splice(t,1),e()}.bind(this)),t},listen:function(e,t){var n;return n=e instanceof siesta._internal.Model?this._listenToModel(e,t):e.listen(t),n&&this.listeners.push(n),this.wrapCancelListen(n)},query:function(e,t,n,i){var s=window.Q?window.Q.defer():FAKE_DEFERRED;return i=i||function(){},e.query(t,function(e,t){if(console.log("done"),e)i(e),s.reject(e);else{var r={};r[n]=t,this.setState(r,function(){i(null,t),s.resolve(t)})}}.bind(this)),s.promise},all:function(e){var t,n,i;return arguments[1]instanceof String||"string"==typeof arguments[1]?(n=arguments[1],i=arguments[2]):(t=arguments[1],n=arguments[2],i=arguments[3]),this.query(e,t,n,i)},isReactiveQuery:function(e){return"function"==typeof e.terminate},_listenAndSetStateForModelInstance:function(e,t,n,i){var s={};if(t=t||{},!t.fields&&!n)throw Error("Must either specify fields or prop");t.fields?isArray(t.fields)?t.fields.forEach(function(t){s[t]=e[t]}):Object.keys(t.fields).forEach(function(n){var i=t.fields[n];s[i]=e[n]}):s[n]=e,this.setState(s),console.log("listening...",e),this.listen(e,function(e){if(console.log("listened!",e),t.fields){var n,i=e.field;if(isArray(t.fields)?n=t.fields.indexOf(e.field)>-1:(n=e.field in t.fields,n&&(i=t.fields[e.field])),n){var s={};s[i]=e.new,this.setState(s)}}else this.setState()}.bind(this)),i(null,e)},listenAndSet:function(e){var t,n,i;"object"==typeof arguments[1]?(t=arguments[1],i=arguments[2]):(t={},n=arguments[1],i=arguments[2]);var s=window.Q?window.Q.defer():FAKE_DEFERRED;i=i||function(){};var r={},o=function(){r[n]=e.results,this.setState(r,function(){this.listen(e,function(){if(this.isReactiveQuery(e)){var t={};t[n]=e.results,this.setState(t)}}.bind(this))})}.bind(this);if(this.isReactiveQuery(e))e.initialised?(o.call(this),i(null,e.results),s.resolve(e.results)):e.init(function(){o.call(this),i(null,e.results),s.resolve(e.results)}.bind(this));else if(e instanceof siesta._internal.Model){if(!e.singleton)throw new Error("Can only listenAndSet singleton models");e.one(function(e,r){e?(i(e),s.reject(e)):this._listenAndSetStateForModelInstance(r,t,n,function(e){e?(i(e),s.reject(e)):(i(),s.resolve(r))})}.bind(this))}else{if(!(e instanceof siesta._internal.siestaModel))throw new Error("Cannot listenAndSet objects of that type");this._listenAndSetStateForModelInstance(e,t,n,function(t){t?(i(t),s.reject(t)):(i(),s.resolve(e))})}return s.promise}};"undefined"!=typeof module&&(module.exports={SiestaMixin:SiestaMixin}),"undefined"!=typeof window&&(window.SiestaMixin=SiestaMixin);