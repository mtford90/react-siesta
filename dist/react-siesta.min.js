var FAKE_DEFERRED={promise:null,reject:function(){},resolve:function(){}},SiestaMixin={componentWillMount:function(){this.listeners=[]},_cancelListeners:function(){for(var t=0;t<this.listeners.length;t++){var n=this.listeners[t];n()}this.listeners=[]},componentWillUnmount:function(){this._cancelListeners()},_listenToModel:function(t,n){var e;if(!t.singleton)throw new Error("Cannot listen to a Model if it is not a singleton");return t.one(function(t,i){console.log("singleton",i),t?n(t):(e=this.listen(i,function(t){n(t)}),this.listeners.push(e))}.bind(this)),function(){if(e){var t=this.listeners.indexOf(e);this.listeners.splice(t,1),e()}}.bind(this)},wrapCancelListen:function(t){var n;return"function"==typeof t&&(n=function(){var n=this.listeners.indexOf(t);this.listeners.splice(n,1),t()}.bind(this)),n},listen:function(t,n){var e;return e=t instanceof siesta._internal.Model?this._listenToModel(t,n):t.listen(n),e&&this.listeners.push(e),this.wrapCancelListen(e)},query:function(t,n,e,i){var s=window.Q?window.Q.defer():FAKE_DEFERRED;return i=i||function(){},t.query(n,function(t,n){if(console.log("done"),t)i(t),s.reject(t);else{var o={};o[e]=n,this.setState(o,function(){i(null,n),s.resolve(n)})}}.bind(this)),s.promise},all:function(t){var n,e,i;return arguments[1]instanceof String||"string"==typeof arguments[1]?(e=arguments[1],i=arguments[2]):(n=arguments[1],e=arguments[2],i=arguments[3]),this.query(t,n,e,i)},isReactiveQuery:function(t){return"function"==typeof t.terminate},listenAndSet:function(t){function n(){r[i]=t.results,this.setState(r,function(){this.listen(t,function(){if(this.isReactiveQuery(t)){var n={};n[i]=t.results,this.setState(n)}}.bind(this))})}var e,i,s;"object"==typeof arguments[1]?(e=arguments[1],i=arguments[2],s=arguments[3]):(e={},i=arguments[1],s=arguments[2]);var o=window.Q?window.Q.defer():FAKE_DEFERRED;s=s||function(){};var r={};if(this.isReactiveQuery(t))t.initialised?(n.call(this),s(null,t.results),o.resolve(t.results)):t.init(function(){n.call(this),s(null,t.results),o.resolve(t.results)}.bind(this));else{if(!(t instanceof siesta._internal.Model))throw new Error("Cannot listenAndSet objects of that type");if(!t.singleton)throw new Error("Can only listenAndSet singleton models");var l=e.fields;l?(t.one(function(t,n){if(t)s(t),o.reject(t);else{for(var e={},i=0;i<l.length;i++){var r=l[i];e[r]=n[r]}this.setState(e),s(null,n),o.resolve(n)}}.bind(this)),console.log("listening...",t),this.listen(t,function(t){if(console.log("listenAndSet",t),"Set"==t.type&&l.indexOf(t.field)>-1){var n={};n[t.field]=t.new,this.setState(n)}}.bind(this))):(t.one(function(t,n){if(t)s(t),o.reject(t);else{var e={};e[i]=n,this.setState(e),s(null,n),o.resolve(n)}}.bind(this)),this.listen(t,function(){this.setState()}.bind(this)))}return o.promise}};"undefined"!=typeof module&&(module.exports={SiestaMixin:SiestaMixin}),"undefined"!=typeof window&&(window.SiestaMixin=SiestaMixin);