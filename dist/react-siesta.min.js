var FAKE_DEFERRED={promise:null,reject:function(){},resolve:function(){}},SiestaMixin={componentWillMount:function(){this.listeners=[]},_cancelListeners:function(){for(var e=0;e<this.listeners.length;e++){var t=this.listeners[e];t()}this.listeners=[]},componentWillUnmount:function(){this._cancelListeners()},_listenToModel:function(e,t){var n;if(!e.singleton)throw new Error("Cannot listen to a Model if it is not a singleton");return e.one(function(e,i){console.log("singleton",i),e?t(e):(n=this.listen(i,function(e){t(e)}),this.listeners.push(n))}.bind(this)),function(){if(n){var e=this.listeners.indexOf(n);this.listeners.splice(e,1),n()}}.bind(this)},wrapCancelListen:function(e){var t;return"function"==typeof e&&(t=function(){var t=this.listeners.indexOf(e);this.listeners.splice(t,1),e()}.bind(this)),t},listen:function(e,t){var n;return n=e instanceof siesta._internal.Model?this._listenToModel(e,t):e.listen(t),n&&this.listeners.push(n),this.wrapCancelListen(n)},query:function(e,t,n,i){var s=window.Q?window.Q.defer():FAKE_DEFERRED;return i=i||function(){},e.query(t,function(e,t){if(console.log("done"),e)i(e),s.reject(e);else{var o={};o[n]=t,this.setState(o,function(){i(null,t),s.resolve(t)})}}.bind(this)),s.promise},all:function(e){var t,n,i;return arguments[1]instanceof String||"string"==typeof arguments[1]?(n=arguments[1],i=arguments[2]):(t=arguments[1],n=arguments[2],i=arguments[3]),this.query(e,t,n,i)},isReactiveQuery:function(e){return"function"==typeof e.terminate},listenAndSet:function(e){var t,n,i;"object"==typeof arguments[1]?(t=arguments[1],i=arguments[2]):(t={},n=arguments[1],i=arguments[2]);var s=window.Q?window.Q.defer():FAKE_DEFERRED;i=i||function(){};var o={},r=function(){o[n]=e.results,this.setState(o,function(){this.listen(e,function(){if(this.isReactiveQuery(e)){var t={};t[n]=e.results,this.setState(t)}}.bind(this))})}.bind(this);if(this.isReactiveQuery(e))e.initialised?(r.call(this),i(null,e.results),s.resolve(e.results)):e.init(function(){r.call(this),i(null,e.results),s.resolve(e.results)}.bind(this));else if(e instanceof siesta._internal.Model){if(!e.singleton)throw new Error("Can only listenAndSet singleton models");var l=t.fields;l?(e.one(function(e,t){if(e)i(e),s.reject(e);else{for(var n={},o=0;o<l.length;o++){var r=l[o];n[r]=t[r]}this.setState(n),i(null,t),s.resolve(t)}}.bind(this)),console.log("listening...",e),this.listen(e,function(e){if(console.log("listenAndSet",e),"Set"==e.type&&l.indexOf(e.field)>-1){var t={};t[e.field]=e.new,this.setState(t)}}.bind(this))):(e.one(function(e,t){if(e)i(e),s.reject(e);else{var o={};o[n]=t,this.setState(o),i(null,t),s.resolve(t)}}.bind(this)),this.listen(e,function(){this.setState()}.bind(this)))}else{if(!(e instanceof siesta._internal.siestaModel))throw new Error("Cannot listenAndSet objects of that type");o={},t.fields?t.fields.forEach(function(t){o[t]=e[t]}):o[n]=e,this.setState(o),this.listen(e,function(e){if(t.fields.indexOf(e.field)>-1){var n={};n[e.field]=e.new,this.setState(n)}}.bind(this)),s.resolve(e)}return s.promise}};"undefined"!=typeof module&&(module.exports={SiestaMixin:SiestaMixin}),"undefined"!=typeof window&&(window.SiestaMixin=SiestaMixin);