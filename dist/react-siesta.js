// Just makes the code a tad cleaner if no window.Q available.
var FAKE_DEFERRED = {promise: null, reject: function () {}, resolve: function () {}};

var isArray = Array.isArray || function (obj) {
        return _.toString.call(obj) === '[object Array]';
    };

var SiestaMixin = {
    componentWillMount: function () {
        this.listeners = [];
    },
    _cancelListeners: function () {
        for (var i = 0; i < this.listeners.length; i++) {
            var cancelListener = this.listeners[i];
            cancelListener();
        }
        this.listeners = [];
    },
    componentWillUnmount: function () {
        this._cancelListeners();
    },
    _listenToModel: function (Model, fn) {
        var cancelListen;
        if (Model.singleton) {
            Model.one(function (err, singleton) {
                console.log('singleton', singleton);
                if (!err) {
                    cancelListen = this.listen(singleton, function (n) {fn(n)});
                    this.listeners.push(cancelListen);
                }
                else fn(err);
            }.bind(this));
        }
        else throw new Error('Cannot listen to a Model if it is not a singleton');
        return function () {
            if (cancelListen) {
                var idx = this.listeners.indexOf(cancelListen);
                this.listeners.splice(idx, 1);
                cancelListen();
            }
        }.bind(this);
    },
    wrapCancelListen: function (cancelListen) {
        var wrappedCancelListen;
        if (typeof cancelListen == 'function') {
            wrappedCancelListen = function () {
                var idx = this.listeners.indexOf(cancelListen);
                this.listeners.splice(idx, 1);
                cancelListen();
            }.bind(this)
        }
        return wrappedCancelListen;
    },
    listen: function (o, fn) {
        var cancelListen;
        if (o instanceof siesta._internal.Model) cancelListen = this._listenToModel(o, fn);
        else cancelListen = o.listen(fn);
        if (cancelListen) this.listeners.push(cancelListen);
        return this.wrapCancelListen(cancelListen);
    },
    query: function (model, query, prop, cb) {
        var deferred = window.Q ? window.Q.defer() : FAKE_DEFERRED;
        cb = cb || function () {};
        model.query(query, function (err, res) {
            console.log('done');
            if (!err) {
                var state = {};
                state[prop] = res;
                this.setState(state, function () {
                    cb(null, res);
                    deferred.resolve(res);
                });
            }
            else {
                cb(err);
                deferred.reject(err);
            }
        }.bind(this));
        return deferred.promise;
    },
    all: function (model) {
        var query, prop, cb;
        if (arguments[1] instanceof String || typeof arguments[1] == 'string') {
            prop = arguments[1];
            cb = arguments[2];
        }
        else {
            query = arguments[1];
            prop = arguments[2];
            cb = arguments[3];
        }
        return this.query(model, query, prop, cb);
    },
    isReactiveQuery: function (o) {
        // TODO: Wishy washy. Do instanceof check instead once ReactiveQuery is available on siesta object
        return typeof o.terminate == 'function';
    },
    _listenAndSetStateForModelInstance: function (instance, opts, prop, callback) {
        var state = {};
        opts = opts || {};
        if (!opts.fields && !prop) throw Error('Must either specify fields or prop');
        if (opts.fields) {
            if (isArray(opts.fields)) {
                opts.fields.forEach(function (f) {
                    state[f] = instance[f];
                });
            }
            else {
                Object.keys(opts.fields).forEach(function (f) {
                    var custom = opts.fields[f];
                    state[custom] = instance[f];
                });
            }
        }
        else {
            state[prop] = instance;
        }
        this.setState(state);
        console.log('listening...', instance);
        this.listen(instance, function (e) {
            console.log('listened!', e);
            if (opts.fields) {
                var custom = e.field,
                    doesContain;
                if (isArray(opts.fields)) {
                    doesContain = opts.fields.indexOf(e.field) > -1;
                }
                else {
                    doesContain = e.field in opts.fields;
                    if (doesContain) custom = opts.fields[e.field];
                }
                if (doesContain) {
                    var state = {};
                    state[custom] = e.new;
                    this.setState(state);
                }
            }
            else {
                this.setState();
            }
        }.bind(this));
        callback(null, instance);
    },
    listenAndSet: function (o) {
        var opts, prop, cb;
        if (typeof arguments[1] == 'object') {
            opts = arguments[1];
            cb = arguments[2];
        }
        else {
            opts = {};
            prop = arguments[1];
            cb = arguments[2];
        }
        var deferred = window.Q ? window.Q.defer() : FAKE_DEFERRED;
        cb = cb || function () {};
        var state = {};

        var updateWithResults = function () {
            state[prop] = o.results;
            this.setState(state, function () {
                this.listen(o, function () {
                    if (this.isReactiveQuery(o)) {
                        var state = {};
                        state[prop] = o.results;
                        this.setState(state);
                    }
                }.bind(this));
            });
        }.bind(this);

        if (this.isReactiveQuery(o)) {
            if (o.initialised) {
                updateWithResults.call(this);
                cb(null, o.results);
                deferred.resolve(o.results);
            }
            else {
                o.init(function () {
                    updateWithResults.call(this);
                    cb(null, o.results);
                    deferred.resolve(o.results);
                }.bind(this));
            }
        }
        else if (o instanceof siesta._internal.Model) {
            if (o.singleton) {
                o.one(function (err, instance) {
                    if (err) {
                        cb(err);
                        deferred.reject(err);
                    }
                    else {
                        this._listenAndSetStateForModelInstance(instance, opts, prop, function (err) {
                            if (err) {
                                cb(err);
                                deferred.reject(err);
                            }
                            else {
                                cb();
                                deferred.resolve(instance);
                            }
                        });
                    }
                }.bind(this));
            }
            else {
                throw new Error('Can only listenAndSet singleton models');
            }
        }
        else if (o instanceof siesta._internal.siestaModel) {
            this._listenAndSetStateForModelInstance(o, opts, prop, function (err) {
                if (err) {
                    cb(err);
                    deferred.reject(err);
                }
                else {
                    cb();
                    deferred.resolve(o);
                }
            });
        }
        else {
            throw new Error('Cannot listenAndSet objects of that type');
        }
        return deferred.promise;
    }
};

if (typeof module !== 'undefined') module.exports = {SiestaMixin: SiestaMixin};
if (typeof window !== 'undefined') window.SiestaMixin = SiestaMixin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNmb3JtZWQuanMiLCJzb3VyY2VzIjpbbnVsbF0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLDhEQUE4RDtBQUM5RCxJQUFJLGFBQWEsR0FBRyxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDOztBQUVyRixJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUMsT0FBTyxJQUFJLFVBQVUsR0FBRyxFQUFFO1FBQ3RDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssZ0JBQWdCLENBQUM7QUFDekQsS0FBSyxDQUFDOztBQUVOLElBQUksV0FBVyxHQUFHO0lBQ2Qsa0JBQWtCLEVBQUUsWUFBWTtRQUM1QixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztLQUN2QjtJQUNELGdCQUFnQixFQUFFLFlBQVk7UUFDMUIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzVDLElBQUksY0FBYyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdkMsY0FBYyxFQUFFLENBQUM7U0FDcEI7UUFDRCxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztLQUN2QjtJQUNELG9CQUFvQixFQUFFLFlBQVk7UUFDOUIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7S0FDM0I7SUFDRCxjQUFjLEVBQUUsVUFBVSxLQUFLLEVBQUUsRUFBRSxFQUFFO1FBQ2pDLElBQUksWUFBWSxDQUFDO1FBQ2pCLElBQUksS0FBSyxDQUFDLFNBQVMsRUFBRTtZQUNqQixLQUFLLENBQUMsR0FBRyxDQUFDLFVBQVUsR0FBRyxFQUFFLFNBQVMsRUFBRTtnQkFDaEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsU0FBUyxD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QztpQkFDdkI7YUFDSixDQUFDLENBQUM7U0FDTjthQUNJO1lBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO1NBQy9EO1FBQ0QsT0FBTyxRQUFRLENBQUMsT0FBTyxDQUFDO0tBQzNCO0FBQ0wsQ0FBQyxDQUFDOztBQUVGLElBQUksT0FBTyxNQUFNLEtBQUssV0FBVyxFQUFFLE1BQU0sQ0FBQyxPQUFPLEdBQUcsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLENBQUM7QUFDL0UsSUFBSSxPQUFPLE1BQU0sS0FBSyxXQUFXLEVBQUUsTUFBTSxDQUFDLFdBQVcsR0FBRyxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiLy8gSnVzdCBtYWtlcyB0aGUgY29kZSBhIHRhZCBjbGVhbmVyIGlmIG5vIHdpbmRvdy5RIGF2YWlsYWJsZS5cbnZhciBGQUtFX0RFRkVSUkVEID0ge3Byb21pc2U6IG51bGwsIHJlamVjdDogZnVuY3Rpb24gKCkge30sIHJlc29sdmU6IGZ1bmN0aW9uICgpIHt9fTtcblxudmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uIChvYmopIHtcbiAgICAgICAgcmV0dXJuIF8udG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBBcnJheV0nO1xuICAgIH07XG5cbnZhciBTaWVzdGFNaXhpbiA9IHtcbiAgICBjb21wb25lbnRXaWxsTW91bnQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy5saXN0ZW5lcnMgPSBbXTtcbiAgICB9LFxuICAgIF9jYW5jZWxMaXN0ZW5lcnM6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxpc3RlbmVycy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgdmFyIGNhbmNlbExpc3RlbmVyID0gdGhpcy5saXN0ZW5lcnNbaV07XG4gICAgICAgICAgICBjYW5jZWxMaXN0ZW5lcigpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubGlzdGVuZXJzID0gW107XG4gICAgfSxcbiAgICBjb21wb25lbnRXaWxsVW5tb3VudDogZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLl9jYW5jZWxMaXN0ZW5lcnMoKTtcbiAgICB9LFxuICAgIF9saXN0ZW5Ub01vZGVsOiBmdW5jdGlvbiAoTW9kZWwsIGZuKSB7XG4gICAgICAgIHZhciBjYW5jZWxMaXN0ZW47XG4gICAgICAgIGlmIChNb2RlbC5zaW5nbGV0b24pIHtcbiAgICAgICAgICAgIE1vZGVsLm9uZShmdW5jdGlvbiAoZXJyLCBzaW5nbGV0b24pIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnc2luZ2xldG9uJywgc2luZ2xldG9uKTtcbiAgICAgICAgICAgICAgICBpZiAoIWVycikge1xuICAgICAgICAgICAgICAgICAgICBjYW5jZWxMaXN0ZW4gPSB0aGlzLmxpc3RlbihzaW5nbGV0b24sIGZ1bmN0aW9uIChuKSB7Zm4obil9KTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5saXN0ZW5lcnMucHVzaChjYW5jZWxMaXN0ZW4pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGZuKGVycik7XG4gICAgICAgICAgICB9LmJpbmQodGhpcykpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgbGlzdGVuIHRvIGEgTW9kZWwgaWYgaXQgaXMgbm90IGEgc2luZ2xldG9uJyk7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAoY2FuY2VsTGlzdGVuKSB7XG4gICAgICAgICAgICAgICAgdmFyIGlkeCA9IHRoaXMubGlzdGVuZXJzLmluZGV4T2YoY2FuY2VsTGlzdGVuKTtcbiAgICAgICAgICAgICAgICB0aGlzLmxpc3RlbmVycy5zcGxpY2UoaWR4LCAxKTtcbiAgICAgICAgICAgICAgICBjYW5jZWxMaXN0ZW4oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfS5iaW5kKHRoaXMpO1xuICAgIH0sXG4gICAgd3JhcENhbmNlbExpc3RlbjogZnVuY3Rpb24gKGNhbmNlbExpc3Rlbikge1xuICAgICAgICB2YXIgd3JhcHBlZENhbmNlbExpc3RlbjtcbiAgICAgICAgaWYgKHR5cGVvZiBjYW5jZWxMaXN0ZW4gPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgd3JhcHBlZENhbmNlbExpc3RlbiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgaWR4ID0gdGhpcy5saXN0ZW5lcnMuaW5kZXhPZihjYW5jZWxMaXN0ZW4pO1xuICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuZXJzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgICAgICAgIGNhbmNlbExpc3RlbigpO1xuICAgICAgICAgICAgfS5iaW5kKHRoaXMpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHdyYXBwZWRDYW5jZWxMaXN0ZW47XG4gICAgfSxcbiAgICBsaXN0ZW46IGZ1bmN0aW9uIChvLCBmbikge1xuICAgICAgICB2YXIgY2FuY2VsTGlzdGVuO1xuICAgICAgICBpZiAobyBpbnN0YW5jZW9mIHNpZXN0YS5faW50ZXJuYWwuTW9kZWwpIGNhbmNlbExpc3RlbiA9IHRoaXMuX2xpc3RlblRvTW9kZWwobywgZm4pO1xuICAgICAgICBlbHNlIGNhbmNlbExpc3RlbiA9IG8ubGlzdGVuKGZuKTtcbiAgICAgICAgaWYgKGNhbmNlbExpc3RlbikgdGhpcy5saXN0ZW5lcnMucHVzaChjYW5jZWxMaXN0ZW4pO1xuICAgICAgICByZXR1cm4gdGhpcy53cmFwQ2FuY2VsTGlzdGVuKGNhbmNlbExpc3Rlbik7XG4gICAgfSxcbiAgICBxdWVyeTogZnVuY3Rpb24gKG1vZGVsLCBxdWVyeSwgcHJvcCwgY2IpIHtcbiAgICAgICAgdmFyIGRlZmVycmVkID0gd2luZG93LlEgPyB3aW5kb3cuUS5kZWZlcigpIDogRkFLRV9ERUZFUlJFRDtcbiAgICAgICAgY2IgPSBjYiB8fCBmdW5jdGlvbiAoKSB7fTtcbiAgICAgICAgbW9kZWwucXVlcnkocXVlcnksIGZ1bmN0aW9uIChlcnIsIHJlcykge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ2RvbmUnKTtcbiAgICAgICAgICAgIGlmICghZXJyKSB7XG4gICAgICAgICAgICAgICAgdmFyIHN0YXRlID0ge307XG4gICAgICAgICAgICAgICAgc3RhdGVbcHJvcF0gPSByZXM7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBjYihudWxsLCByZXMpO1xuICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlcyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjYihlcnIpO1xuICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlcnIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LmJpbmQodGhpcykpO1xuICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcbiAgICB9LFxuICAgIGFsbDogZnVuY3Rpb24gKG1vZGVsKSB7XG4gICAgICAgIHZhciBxdWVyeSwgcHJvcCwgY2I7XG4gICAgICAgIGlmIChhcmd1bWVudHNbMV0gaW5zdGFuY2VvZiBTdHJpbmcgfHwgdHlwZW9mIGFyZ3VtZW50c1sxXSA9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgcHJvcCA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgICAgIGNiID0gYXJndW1lbnRzWzJdO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcXVlcnkgPSBhcmd1bWVudHNbMV07XG4gICAgICAgICAgICBwcm9wID0gYXJndW1lbnRzWzJdO1xuICAgICAgICAgICAgY2IgPSBhcmd1bWVudHNbM107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMucXVlcnkobW9kZWwsIHF1ZXJ5LCBwcm9wLCBjYik7XG4gICAgfSxcbiAgICBpc1JlYWN0aXZlUXVlcnk6IGZ1bmN0aW9uIChvKSB7XG4gICAgICAgIC8vIFRPRE86IFdpc2h5IHdhc2h5LiBEbyBpbnN0YW5jZW9mIGNoZWNrIGluc3RlYWQgb25jZSBSZWFjdGl2ZVF1ZXJ5IGlzIGF2YWlsYWJsZSBvbiBzaWVzdGEgb2JqZWN0XG4gICAgICAgIHJldHVybiB0eXBlb2Ygby50ZXJtaW5hdGUgPT0gJ2Z1bmN0aW9uJztcbiAgICB9LFxuICAgIF9saXN0ZW5BbmRTZXRTdGF0ZUZvck1vZGVsSW5zdGFuY2U6IGZ1bmN0aW9uIChpbnN0YW5jZSwgb3B0cywgcHJvcCwgY2FsbGJhY2spIHtcbiAgICAgICAgdmFyIHN0YXRlID0ge307XG4gICAgICAgIG9wdHMgPSBvcHRzIHx8IHt9O1xuICAgICAgICBpZiAoIW9wdHMuZmllbGRzICYmICFwcm9wKSB0aHJvdyBFcnJvcignTXVzdCBlaXRoZXIgc3BlY2lmeSBmaWVsZHMgb3IgcHJvcCcpO1xuICAgICAgICBpZiAob3B0cy5maWVsZHMpIHtcbiAgICAgICAgICAgIGlmIChpc0FycmF5KG9wdHMuZmllbGRzKSkge1xuICAgICAgICAgICAgICAgIG9wdHMuZmllbGRzLmZvckVhY2goZnVuY3Rpb24gKGYpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGVbZl0gPSBpbnN0YW5jZVtmXTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKG9wdHMuZmllbGRzKS5mb3JFYWNoKGZ1bmN0aW9uIChmKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjdXN0b20gPSBvcHRzLmZpZWxkc1tmXTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGVbY3VzdG9tXSA9IGluc3RhbmNlW2ZdO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgc3RhdGVbcHJvcF0gPSBpbnN0YW5jZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldFN0YXRlKHN0YXRlKTtcbiAgICAgICAgY29uc29sZS5sb2coJ2xpc3RlbmluZy4uLicsIGluc3RhbmNlKTtcbiAgICAgICAgdGhpcy5saXN0ZW4oaW5zdGFuY2UsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnbGlzdGVuZWQhJywgZSk7XG4gICAgICAgICAgICBpZiAob3B0cy5maWVsZHMpIHtcbiAgICAgICAgICAgICAgICB2YXIgY3VzdG9tID0gZS5maWVsZCxcbiAgICAgICAgICAgICAgICAgICAgZG9lc0NvbnRhaW47XG4gICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkob3B0cy5maWVsZHMpKSB7XG4gICAgICAgICAgICAgICAgICAgIGRvZXNDb250YWluID0gb3B0cy5maWVsZHMuaW5kZXhPZihlLmZpZWxkKSA+IC0xO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZG9lc0NvbnRhaW4gPSBlLmZpZWxkIGluIG9wdHMuZmllbGRzO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZG9lc0NvbnRhaW4pIGN1c3RvbSA9IG9wdHMuZmllbGRzW2UuZmllbGRdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZG9lc0NvbnRhaW4pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlID0ge307XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlW2N1c3RvbV0gPSBlLm5ldztcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LmJpbmQodGhpcykpO1xuICAgICAgICBjYWxsYmFjayhudWxsLCBpbnN0YW5jZSk7XG4gICAgfSxcbiAgICBsaXN0ZW5BbmRTZXQ6IGZ1bmN0aW9uIChvKSB7XG4gICAgICAgIHZhciBvcHRzLCBwcm9wLCBjYjtcbiAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbMV0gPT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgIG9wdHMgPSBhcmd1bWVudHNbMV07XG4gICAgICAgICAgICBjYiA9IGFyZ3VtZW50c1syXTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIG9wdHMgPSB7fTtcbiAgICAgICAgICAgIHByb3AgPSBhcmd1bWVudHNbMV07XG4gICAgICAgICAgICBjYiA9IGFyZ3VtZW50c1syXTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgZGVmZXJyZWQgPSB3aW5kb3cuUSA/IHdpbmRvdy5RLmRlZmVyKCkgOiBGQUtFX0RFRkVSUkVEO1xuICAgICAgICBjYiA9IGNiIHx8IGZ1bmN0aW9uICgpIHt9O1xuICAgICAgICB2YXIgc3RhdGUgPSB7fTtcblxuICAgICAgICB2YXIgdXBkYXRlV2l0aFJlc3VsdHMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBzdGF0ZVtwcm9wXSA9IG8ucmVzdWx0cztcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxpc3RlbihvLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzUmVhY3RpdmVRdWVyeShvKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlID0ge307XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVtwcm9wXSA9IG8ucmVzdWx0cztcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfS5iaW5kKHRoaXMpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LmJpbmQodGhpcyk7XG5cbiAgICAgICAgaWYgKHRoaXMuaXNSZWFjdGl2ZVF1ZXJ5KG8pKSB7XG4gICAgICAgICAgICBpZiAoby5pbml0aWFsaXNlZCkge1xuICAgICAgICAgICAgICAgIHVwZGF0ZVdpdGhSZXN1bHRzLmNhbGwodGhpcyk7XG4gICAgICAgICAgICAgICAgY2IobnVsbCwgby5yZXN1bHRzKTtcbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKG8ucmVzdWx0cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBvLmluaXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB1cGRhdGVXaXRoUmVzdWx0cy5jYWxsKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBjYihudWxsLCBvLnJlc3VsdHMpO1xuICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKG8ucmVzdWx0cyk7XG4gICAgICAgICAgICAgICAgfS5iaW5kKHRoaXMpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChvIGluc3RhbmNlb2Ygc2llc3RhLl9pbnRlcm5hbC5Nb2RlbCkge1xuICAgICAgICAgICAgaWYgKG8uc2luZ2xldG9uKSB7XG4gICAgICAgICAgICAgICAgby5vbmUoZnVuY3Rpb24gKGVyciwgaW5zdGFuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2IoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbGlzdGVuQW5kU2V0U3RhdGVGb3JNb2RlbEluc3RhbmNlKGluc3RhbmNlLCBvcHRzLCBwcm9wLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYihlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNiKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoaW5zdGFuY2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfS5iaW5kKHRoaXMpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2FuIG9ubHkgbGlzdGVuQW5kU2V0IHNpbmdsZXRvbiBtb2RlbHMnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChvIGluc3RhbmNlb2Ygc2llc3RhLl9pbnRlcm5hbC5zaWVzdGFNb2RlbCkge1xuICAgICAgICAgICAgdGhpcy5fbGlzdGVuQW5kU2V0U3RhdGVGb3JNb2RlbEluc3RhbmNlKG8sIG9wdHMsIHByb3AsIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGNiKGVycik7XG4gICAgICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY2IoKTtcbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShvKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGxpc3RlbkFuZFNldCBvYmplY3RzIG9mIHRoYXQgdHlwZScpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICAgIH1cbn07XG5cbmlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJykgbW9kdWxlLmV4cG9ydHMgPSB7U2llc3RhTWl4aW46IFNpZXN0YU1peGlufTtcbmlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgd2luZG93LlNpZXN0YU1peGluID0gU2llc3RhTWl4aW47Il19